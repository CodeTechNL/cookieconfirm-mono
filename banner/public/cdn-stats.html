<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cookie Confirm – CDN Status</title>
  <style>
    :root {
      --bg:#f7f8fb; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --border:#e5e7eb;
      --btn-bg:#fff; --btn-border:#e5e7eb; --btn-hover:#f8fafc;
      --ok:#16a34a; --warn:#d97706; --err:#dc2626;
      --input-bg:#fff; --input-text:#0f172a;
    }
    [data-theme="dark"] {
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937;
      --btn-bg:#0b1222; --btn-border:#1f2937; --btn-hover:#0e1629;
      --input-bg:#0b1222; --input-text:#e5e7eb;
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell;
      background: var(--bg); color: var(--text);
    }

    .wrap { min-height: 100%; display: grid; place-items: center; padding: 16px; }
    .card {
      max-width: 980px; width: 100%;
      background: var(--card); border: 1px solid var(--border); border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,.06);
      padding: 20px 16px 16px; position: relative;
    }

    .topbar { position: absolute; top: 12px; right: 16px; display: flex; gap: 8px; }
    .btn {
      appearance: none; border: 1px solid var(--btn-border); background: var(--btn-bg); color: var(--text);
      padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px;
    }
    .btn:hover { background: var(--btn-hover); }

    .header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 14px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
      margin-bottom: 16px; padding-top: 30px;
    }
    .titlebox { display: flex; flex-direction: column; gap: 2px; }
    .title { font-size: 18px; font-weight: 600; letter-spacing: .2px; }
    .subtitle { color: var(--muted); font-size: 12px; }
    .logo { height: 20px; width: auto; object-fit: contain; }

    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .seg { display: flex; gap: 8px; align-items: center; flex: 1 1 280px; min-width: 0; }
    label { color: var(--muted); font-size: 13px; white-space: nowrap; }
    .input {
      flex: 1 1 auto; min-width: 0; width: 100%;
      padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border);
      background: var(--input-bg); color: var(--input-text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }

    .error-msg { color: var(--err); font-size: 12px; margin-top: 4px; margin-left: 2px; display: none; }

    .grid { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; margin-top: 14px; }
    .stat { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; min-height: 92px; }
    .label { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .value { font-size: 22px; font-weight: 700; letter-spacing: .2px; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 4px; word-break: break-word; }

    .ok { color: var(--ok); } .warn { color: var(--warn); } .err { color: var(--err); }

    pre {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      padding: 12px; margin-top: 16px;
      white-space: pre-wrap; word-break: break-word; font-size: 12px;
    }

    @media (max-width: 720px) {
      .header { flex-direction: column; align-items: center; gap: 8px; text-align: center; }
      .logo { order: -1; }
      .controls { flex-direction: column; align-items: stretch; }
      .grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .topbar { position: static; justify-content: center; margin-bottom: 8px; }
      .card { padding-left: 16px; padding-right: 16px; } /* symmetrisch */
    }
    @media (max-width: 480px) { .grid { grid-template-columns: 1fr; } .value { font-size: 20px; } }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <button class="btn" id="lang-toggle">EN</button>
      <button class="btn" id="theme-toggle">Light</button>
    </div>

    <div class="header">
      <div class="titlebox">
        <div class="title" data-i18n="title">Cookie Confirm CDN</div>
        <div class="subtitle" data-i18n="subtitle">Live measurement of latency, payload, status and viewer country</div>
      </div>
      <img class="logo" src="/images/logo.png" alt="Cookie Confirm logo" />
    </div>

    <div class="controls">
      <div class="seg">
        <label for="endpoint" data-i18n="url">URL:</label>
        <input id="endpoint" class="input" type="text" placeholder="https://example.com/path" />
      </div>
      <div class="seg" style="flex:0 0 auto;">
        <button class="btn" id="run" data-i18n="measure">Measure</button>
        <button class="btn" id="auto" data-i18n="auto">Auto</button>
      </div>
    </div>
    <div id="error" class="error-msg">URL is required.</div>

    <div class="grid">
      <div class="stat">
        <div class="label" data-i18n="respTime">Response time</div>
        <div class="value"><span class="cc-response-time">–</span> ms</div>
        <div class="hint"><span class="cc-cache" data-i18n="cache">Cache: –</span></div>
      </div>
      <div class="stat">
        <div class="label" data-i18n="respSize">Response size</div>
        <div class="value"><span class="cc-response-bytes">–</span></div>
        <div class="hint" data-i18n="sizeHint">Based on <code>Content-Length</code> or measured</div>
      </div>
      <div class="stat">
        <div class="label" data-i18n="httpStatus">HTTP status</div>
        <div class="value cc-status">–</div>
        <div class="hint cc-status-text">–</div>
      </div>
      <div class="stat">
        <div class="label" data-i18n="viewerCountry">Viewer country</div>
        <div class="value"><span class="cc-response-country">–</span></div>
        <div class="hint" data-i18n="countryHint">From <code>X-Viewer-Country</code> header</div>
      </div>
      <div class="stat">
        <div class="label" data-i18n="age">Cache age</div>
        <div class="value"><span class="cc-age">–</span></div>
        <div class="hint" data-i18n="ageHint">From <code>Age</code> header (seconds)</div>
      </div>
    </div>

    <pre id="header-output">(no headers yet)</pre>
  </div>
</div>

<script>
  (function(){
    // Elements
    const elTime = document.querySelector('.cc-response-time');
    const elBytes = document.querySelector('.cc-response-bytes');
    const elCountry = document.querySelector('.cc-response-country');
    const elCache = document.querySelector('.cc-cache');
    const elStatus = document.querySelector('.cc-status');
    const elStatusText = document.querySelector('.cc-status-text');
    const elAge = document.querySelector('.cc-age');
    const elEndpoint = document.getElementById('endpoint');
    const elError = document.getElementById('error');
    const elHeaderOutput = document.getElementById('header-output');

    const btnRun = document.getElementById('run');
    const btnAuto = document.getElementById('auto');
    const btnLang = document.getElementById('lang-toggle');
    const btnTheme = document.getElementById('theme-toggle');

    // State
    let autoTimer = null;
    let lang = (localStorage.getItem('cc_lang') || 'en').toLowerCase();
    let theme = (localStorage.getItem('cc_theme') || 'light').toLowerCase();

    // i18n
    const I18N = {
      en: {
        title:"Cookie Confirm CDN",
        subtitle:"Live measurement of latency, payload, status and viewer country",
        url:"URL:",
        measure:"Measure",
        auto:"Auto",
        stop:"Stop",
        respTime:"Response time",
        respSize:"Response size",
        sizeHint:"Based on <code>Content-Length</code> or measured",
        httpStatus:"HTTP status",
        viewerCountry:"Viewer country",
        countryHint:"From <code>X-Viewer-Country</code> header",
        cache:"Cache: –",
        age:"Cache age",
        ageHint:"From <code>Age</code> header (seconds)",
        urlReq:"URL is required.",
        themeLight:"Light",
        themeDark:"Dark"
      },
      nl: {
        title:"Cookie Confirm CDN",
        subtitle:"Live meting van latency, payload, status en viewer country",
        url:"URL:",
        measure:"Meten",
        auto:"Auto",
        stop:"Stop",
        respTime:"Responstijd",
        respSize:"Responsgrootte",
        sizeHint:"Op basis van <code>Content-Length</code> of gemeten",
        httpStatus:"HTTP-status",
        viewerCountry:"Viewer land",
        countryHint:"Uit <code>X-Viewer-Country</code> header",
        cache:"Cache: –",
        age:"Cache leeftijd",
        ageHint:"Uit <code>Age</code> header (seconden)",
        urlReq:"URL is verplicht.",
        themeLight:"Licht",
        themeDark:"Donker"
      }
    };
    function t(k){ return (I18N[lang] && I18N[lang][k]) || I18N.en[k] || k; }

    function applyTheme(tname){
      document.documentElement.setAttribute('data-theme', tname);
      localStorage.setItem('cc_theme', tname);
      btnTheme.textContent = (tname === 'light') ? t('themeLight') : t('themeDark');
    }
    function applyI18n(){
      document.querySelectorAll('[data-i18n]').forEach(n=>{
        const key = n.getAttribute('data-i18n');
        if (n.tagName === 'LABEL' || n.classList.contains('subtitle') || n.classList.contains('label')) {
          n.textContent = t(key);
        } else {
          n.innerHTML = t(key);
        }
      });
      btnRun.textContent = t('measure');
      btnAuto.textContent = autoTimer ? t('stop') : t('auto');
      btnLang.textContent = lang.toUpperCase();
      btnTheme.textContent = (theme === 'light') ? t('themeLight') : t('themeDark');
      // Update validation message if visible
      if (elError.style.display === 'block') elError.textContent = t('urlReq');
    }

    // ?url= support (no default)
    (function initUrlParam(){
      try {
        const p = new URLSearchParams(window.location.search || '');
        const q = p.get('url');
        if (q) elEndpoint.value = q;
      } catch(e){}
    })();

    function showError(msg){ elError.textContent = msg; elError.style.display = 'block'; }
    function hideError(){ elError.style.display = 'none'; }

    function fmtBytes(n){
      if (n == null || isNaN(n)) return '–';
      const u = ['B','KB','MB','GB']; let i=0; let v=Number(n);
      while (v >= 1024 && i < u.length-1) { v/=1024; i++; }
      return (v<10 && i>0 ? v.toFixed(1) : v.toFixed(0)) + ' ' + u[i];
    }
    function setStatusUI(code, text){
      elStatus.classList.remove('ok','warn','err');
      if (typeof code === 'number') {
        if (code >= 200 && code < 300) elStatus.classList.add('ok');
        else if (code >= 300 && code < 400) elStatus.classList.add('warn');
        else elStatus.classList.add('err');
        elStatus.textContent = String(code);
      } else {
        elStatus.classList.add('err');
        elStatus.textContent = '—';
      }
      elStatusText.textContent = text || '—';
    }
    function headerGet(res, name){ try { return res.headers.get(name) || ''; } catch(e){ return ''; } }
    function headerHas(res, name){ try { return typeof res.headers.has==='function' ? res.headers.has(name) : !!headerGet(res,name); } catch(e){ return false; } }

    async function measureOnce(){
      const url = (elEndpoint.value || '').trim();
      if (!url){ showError(t('urlReq')); return; }
      hideError();

      try {
        const start = performance.now();
        const res = await fetch(url, { cache: 'no-store' });
        setStatusUI(res.status, res.statusText);

        // Read body to include download time
        const ab = await res.arrayBuffer();
        const end = performance.now();
        const dur = end - start;

        const len = parseInt(headerGet(res,'content-length') || '0', 10);
        const bytes = len > 0 ? len : ab.byteLength;

        const country = headerGet(res, 'x-viewer-country') || '—';
        const xcache = headerGet(res, 'x-cache');
        const ageVal = parseInt(headerGet(res,'age') || '0', 10);

        const cacheTxt = xcache
                ? (xcache.toLowerCase().includes('hit') ? `Hit (${xcache})` : `Miss (${xcache})`)
                : (headerHas(res,'age') ? (lang==='nl' ? 'Hit (Age aanwezig)' : 'Hit (Age present)') : '—');

        // Paint UI
        elTime.textContent = dur.toFixed(1);
        elBytes.textContent = fmtBytes(bytes);
        elCountry.textContent = country;
        elAge.textContent = isNaN(ageVal) ? '—' : ageVal + 's';
        elCache.innerHTML = (lang==='nl'?'Cache: ':'Cache: ')
                + `<span class="${cacheTxt.startsWith('Hit')?'ok':(cacheTxt.startsWith('Miss')?'warn':'')}">${cacheTxt}</span>`;

        // Full headers dump
        const lines = [];
        res.headers.forEach((v,k)=>lines.push(`${k}: ${v}`));
        lines.sort((a,b)=>a.localeCompare(b));
        lines.push('', `Duration: ${dur.toFixed(1)} ms`, `Size: ${fmtBytes(bytes)}`);
        elHeaderOutput.textContent = lines.join('\n');

      } catch (e) {
        elTime.textContent='—'; elBytes.textContent='—'; elCountry.textContent='—';
        elAge.textContent='—'; elCache.textContent=(lang==='nl'?'Cache: —':'Cache: —');
        setStatusUI(null, e?.message || (lang==='nl'?'Netwerk- of CORS-fout':'Network or CORS error'));
        elHeaderOutput.textContent = 'Fetch error: ' + (e?.message || 'unknown');
      }
    }

    // Events
    elEndpoint.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') measureOnce(); });
    elEndpoint.addEventListener('input', ()=>{ if (elError.style.display==='block' && elEndpoint.value.trim()) hideError(); });

    btnRun.onclick = ()=>measureOnce();
    btnAuto.onclick = ()=>{
      if (autoTimer) { clearInterval(autoTimer); autoTimer = null; btnAuto.textContent = t('auto'); return; }
      measureOnce(); autoTimer = setInterval(measureOnce, 5000); btnAuto.textContent = t('stop');
    };
    btnLang.onclick = ()=>{
      lang = (lang === 'en' ? 'nl' : 'en');
      localStorage.setItem('cc_lang', lang);
      document.documentElement.lang = lang;
      applyI18n();
    };
    btnTheme.onclick = ()=>{
      theme = (theme === 'light' ? 'dark' : 'light');
      applyTheme(theme);
    };

    // Init
    applyTheme(theme);
    applyI18n();
    // NB: geen automatische meting als er geen URL is (jouw wens)
    const hasUrl = !!(elEndpoint.value && elEndpoint.value.trim());
    if (hasUrl) measureOnce();
  })();
</script>
</body>
</html>
