#!/usr/bin/env node
import * as cdk from 'aws-cdk-lib';
import * as dotenv from 'dotenv';
import * as dotenvExpand from 'dotenv-expand';
import {env, uuid} from "../lib/helpers";
import {PlatformStack} from "../lib/stacks/platform-stack";
import {PhpImageStack} from "../lib/stacks/php-image-stack";
import {CookieScannerStack} from "../lib/stacks/cookie-scanner-stack";

const envResult = dotenv.config({
    path: '../.env',
});

dotenvExpand.expand(envResult);

const app = new cdk.App();

const company = app.node.tryGetContext('company') || 'cookie-confirm'

// new PhpImageStack(app, `Php83Stack`, {
//     imageName: 'ubuntu_php_8_3',
//     env: {
//         region: "eu-west-3",
//         account: env('AWS_ACCOUNT'),
//     }
// })

// new ConsentBannerStack(app, 'ConsentBannerStack', {
//     app: {
//         url: env('APP_DOMAIN'),
//         cdnUrl: `${env('CLOUDFRONT_SUBDOMAIN')}.${env('APP_DOMAIN')}`
//     },
//     aws: {
//         region: env('AWS_REGION'),
//         account: env('AWS_ACCOUNT'),
//     },
//     services: {
//         athena: {
//             workGroup: env('ATHENA_CONSENT_LOGS_WORK_GROUP'),
//             database: env('ATHENA_CONSENT_LOGS_DATABASE'),
//             table: env('ATHENA_CONSENT_LOGS_TABLE'),
//             storagePathS3: env('ATHENA_CONSENT_LOGS_STORAGE_PATH_S3'),
//             athenaConsentLogBucket: env('ATHENA_CONSENT_LOGS_RAW_BUCKET')
//         },
//         cloudfront: {
//             certificateArn: env('CLOUDFRONT_CERTIFICATE_ARN'),
//             hostedZoneDomain: env('APP_DOMAIN'),
//             recordName: env('CLOUDFRONT_SUBDOMAIN')
//         },
//         firehose: {
//             streamName: env('FIREHOSE_CONSENT_LOGS_STREAM'),
//             streamInterval: parseInt(env('FIREHOSE_CONSENT_LOGS_STREAM_INTERVAL')),
//             streamSize: parseInt(env('FIREHOSE_CONSENT_LOGS_STREAM_SIZE'))
//         },
//         s3: {
//             jsonFilesBucketName: env('S3_BANNER_COMPONENTS_BUCKET'),
//             javascriptBucketName: env('S3_BANNER_ASSETS_BUCKET'),
//         }
//     }
// })
//

new CookieScannerStack(app, 'CookieScannerStack', {
    cdk: {
        name: "cookie-confirm",
        stage: "staging"
    },
    env: {
        region: "eu-west-3",
        account: env('AWS_ACCOUNT'),
    }
})

// new ScannerSetupStack(app, 'CookieScannerStack', {
//     queueName: env('SCANNER_QUEUE_NAME'),//"cookie-scanner-queue",
//     apiKey: env('SCANNER_WEBHOOK_SEND_API_KEY'),
//     connectionName: env('SCANNER_EVENT_BRIDGE_CONNECTION_NAME'),
//     endpoint: env('SCANNER_WEBHOOK_POST_ENDPOINT'),
//     eventDetailType: env('SCANNER_EVENT_BRIDGE_EVENT_DETAIL_TYPE'),
//     eventSourceName: env('SCANNER_EVENT_BRIDGE_EVENT_SOURCE_NAME'),
//     busName: env('SCANNER_EVENT_BRIDGE_EVENT_BUS_NAME'),
//     env: {
//         region: env('AWS_REGION'),
//     }
// })



new PlatformStack(app, 'PlatformStack', {
    version: uuid(),
    cdk: {
        name: 'cookie-confirm',
        stage: 'staging',
        baseDockerImage: '585008041582.dkr.ecr.eu-west-3.amazonaws.com/cdk-hnb659fds-container-assets-585008041582-eu-west-3:00bbf7bd00166c64d2fa83e315d2c261695a3da459e3899cd50bf9a52a96eb2f',
        certificateArn: 'arn:aws:acm:eu-west-3:585008041582:certificate/4b315ff2-8173-4192-a786-3ff9fca41399'
    },
    env: {
        region: "eu-west-3",
        account: env('AWS_ACCOUNT'),
    }
})

app.synth();
